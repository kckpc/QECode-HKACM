(this["webpackJsonpqr-checkin-app"]=this["webpackJsonpqr-checkin-app"]||[]).push([[0],{18:function(e,t,c){},24:function(e,t,c){"use strict";c.r(t);var s=c(3),a=c.n(s),n=c(10),i=c.n(n),r=c(11),l=c(26),o=c(12),d=(c(18),c(1));function j(e){return e.toLocaleString("en-US",{timeZone:"Asia/Hong_Kong",year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1})}var h=function(){const[e,t]=Object(s.useState)(""),[c,a]=Object(s.useState)(null),[n,i]=Object(s.useState)(!1),[h,b]=Object(s.useState)(null),[u,O]=Object(s.useState)(""),[m,p]=Object(s.useState)(null),[x,g]=Object(s.useState)(!1),[v,y]=Object(s.useState)(""),[k,N]=Object(s.useState)(!1),[f,w]=Object(s.useState)(!1),[S,I]=Object(s.useState)(!0),[D,C]=Object(s.useState)(!1),[$,E]=Object(s.useState)(""),[T,A]=Object(s.useState)("HKACM \u4e8c\u7dad\u78bc\u7c3d\u5230\u7cfb\u7d71"),[M,q]=Object(s.useState)(""),[_,F]=Object(s.useState)(""),[P,H]=Object(s.useState)(0),[J,L]=Object(s.useState)(""),[U,z]=Object(s.useState)(0),[B,K]=Object(s.useState)({}),V="https://192.168.0.119:3001",[Y,R]=Object(s.useState)(!1),[W,Z]=Object(s.useState)(!1),[G,Q]=Object(s.useState)([]),[X,ee]=Object(s.useState)(null),[te,ce]=Object(s.useState)(!1),[se,ae]=Object(s.useState)(!1),ne=Object(s.useCallback)((async()=>{try{const e=(await navigator.mediaDevices.enumerateDevices()).filter((e=>"videoinput"===e.kind));Q(e),e.length>0&&!X&&ee(e[0].deviceId)}catch(m){console.error("Error getting cameras:",m),p("\u7121\u6cd5\u7372\u53d6\u651d\u50cf\u982d\u5217\u8868")}}),[X]);Object(s.useEffect)((()=>(ne(),navigator.mediaDevices.addEventListener("devicechange",ne),()=>{navigator.mediaDevices.removeEventListener("devicechange",ne)})),[ne]);const ie=async()=>{try{const e=await l.a.get(`${V}/api/participants`),t={};e.data.forEach((e=>{t[e.id]=e}));const c=Object.values(t).sort(((e,t)=>{const c=e.checkIns&&e.checkIns.length>0?new Date(e.checkIns[0]).getTime():0;return(t.checkIns&&t.checkIns.length>0?new Date(t.checkIns[0]).getTime():0)-c})),s={};c.forEach((e=>{s[e.id]=e})),K(s),p(null)}catch(e){p("\u7121\u6cd5\u7372\u53d6\u53c3\u8207\u8005\u8cc7\u6599\u3002\u8acb\u7a0d\u5f8c\u518d\u8a66\u3002"),console.error("Error fetching participants:",e)}},re=Object(s.useCallback)((async e=>{console.log("Checking participant with ID:",e),i(!0);try{const c=(new Date).toISOString();console.log("Sending check-in request to server...");const s=await l.a.post(`${V}/api/check-in`,{qrData:e,checkInTime:c,isDemoMode:S,activityName:M});if(console.log("Server response:",s.data),s.data.participant){const c={...s.data.participant,id:e,signedToday:!1},n=new Date,i=new Date(n.getFullYear(),n.getMonth(),n.getDate());c.signedToday=c.checkIns.some((e=>new Date(e)>=i)),a(c),L(`ID: ${e} - ${s.data.message}${s.data.isDuplicate?" (\u91cd\u8907\u7c3d\u5230)":""}`),H(s.data.dailyCheckInCount),z(s.data.totalPeople),await ie(),t("")}else a(null),L(`ID: ${e} - ${s.data.message}`);p(null)}catch(c){console.error("Error checking participant:",c),L(`ID: ${e} - \u6aa2\u67e5\u53c3\u8207\u8005\u6642\u767c\u751f\u932f\u8aa4`),a(null),l.a.isAxiosError(c)&&c.response?p(`\u932f\u8aa4\uff1a${c.response.status} - ${c.response.data.message}`):p("\u767c\u751f\u672a\u77e5\u932f\u8aa4")}finally{i(!1),W&&setTimeout((()=>R(!0)),2e3)}}),[W,M,S]),le=async()=>{try{const e=await l.a.get(`${V}/api/total-people`);z(e.data.totalPeople)}catch(m){console.error("Error fetching total number of people:",m)}},oe=Object(s.useCallback)((e=>{if(e){const t=e.getText();console.log("Scan result:",t),re(t),W||(R(!1),ce(!1))}}),[W,re]),de=async()=>{try{const e=await l.a.get(`${V}/api/daily-check-in-count`);H(e.data.dailyCheckInCount)}catch(m){console.error("Error fetching daily check-in count:",m),p("\u7121\u6cd5\u7372\u53d6\u4eca\u65e5\u7e3d\u7c3d\u5230\u6b21\u6578")}};Object(s.useEffect)((()=>{(async()=>{await le(),await de(),await je()})();const e=setInterval((()=>{le(),de()}),3e5);return()=>clearInterval(e)}),[]);const je=async()=>{try{const e=await l.a.get(`${V}/api/current-activity`);q(e.data.currentActivityName),F(e.data.currentActivityName)}catch(m){console.error("Error fetching current activity:",m)}};return Object(d.jsxs)("div",{className:"App",children:[Object(d.jsxs)("header",{className:"App-header",children:[Object(d.jsx)("h1",{children:T}),Object(d.jsx)("h2",{children:M||"\u672a\u8a2d\u5b9a\u7576\u524d\u6d3b\u52d5"}),Object(d.jsxs)("div",{className:"mode-switch",children:[Object(d.jsxs)("span",{children:["\u76ee\u524d\u6a21\u5f0f\uff1a",S?"\u6f14\u793a":"\u6b63\u5f0f"]}),Object(d.jsxs)("button",{onClick:()=>{C(!0)},className:"mode-switch-button",children:["\u5207\u63db\u81f3",S?"\u6b63\u5f0f":"\u6f14\u793a","\u6a21\u5f0f"]})]})]}),Object(d.jsxs)("main",{className:"App-main",children:[m&&Object(d.jsx)("div",{className:"error-message",children:m}),D&&Object(d.jsx)("div",{className:"modal mode-switch-confirmation",children:Object(d.jsxs)("div",{className:"modal-content",children:[Object(d.jsx)("h3",{children:"\u78ba\u8a8d\u6a21\u5f0f\u5207\u63db"}),Object(d.jsxs)("p",{children:["\u8acb\u8f38\u5165\u7ba1\u7406\u54e1\u5bc6\u78bc\u4ee5\u5207\u63db\u81f3",S?"\u6b63\u5f0f":"\u6f14\u793a","\u6a21\u5f0f\uff1a"]}),Object(d.jsxs)("form",{onSubmit:async e=>{if(e.preventDefault(),"hkacmadmin"===$)try{const e=!S;(await l.a.post(`${V}/api/set-demo-mode`,{isDemoMode:e})).data.success?(I(e),C(!1),E(""),p(null),L(`\u5df2\u5207\u63db\u81f3${e?"\u6f14\u793a":"\u6b63\u5f0f"}\u6a21\u5f0f`)):p("\u5207\u63db\u6a21\u5f0f\u5931\u6557\u3002\u8acb\u7a0d\u5f8c\u518d\u8a66\u3002")}catch(t){p("\u5207\u63db\u6a21\u5f0f\u6642\u767c\u751f\u932f\u8aa4\u3002\u8acb\u7a0d\u5f8c\u518d\u8a66\u3002"),console.error("Error switching modes:",t)}else p("\u6a21\u5f0f\u5207\u63db\u5bc6\u78bc\u932f\u8aa4")},className:"mode-switch-form",children:[Object(d.jsx)("input",{type:"password",value:$,onChange:e=>{E(e.target.value)},placeholder:"\u8f38\u5165\u7ba1\u7406\u54e1\u5bc6\u78bc",className:"input-field"}),Object(d.jsxs)("div",{className:"button-group",children:[Object(d.jsx)("button",{type:"submit",className:"submit-button",children:"\u78ba\u8a8d\u5207\u63db"}),Object(d.jsx)("button",{onClick:()=>C(!1),className:"cancel-button",children:"\u53d6\u6d88"})]})]})]})}),Object(d.jsxs)("section",{className:"check-in-section",children:[Object(d.jsx)("h2",{children:"\u7c3d\u5230"}),Object(d.jsxs)("form",{onSubmit:async c=>{c.preventDefault(),e.trim()&&(await re(e),t(""))},className:"check-in-form",children:[Object(d.jsx)("input",{type:"text",value:e,onChange:e=>{t(e.target.value)},placeholder:"\u624b\u52d5\u8f38\u5165\u53c3\u8207\u8005ID\u6216\u6383\u63cf\u4e8c\u7dad\u78bc",className:"input-field"}),Object(d.jsx)("button",{type:"submit",className:"submit-button",children:"\u63d0\u4ea4"})]}),Object(d.jsxs)("div",{className:"qr-scanner-section",children:[Object(d.jsxs)("p",{className:"status-message",children:["\u6700\u5f8c\u7c3d\u5230\u72c0\u614b\uff1a",J]}),Object(d.jsx)("select",{value:X||"",onChange:e=>{const t=e.target.value;ee(t),R(!1)},disabled:Y,children:G.map((e=>Object(d.jsx)("option",{value:e.deviceId,children:e.label||`Camera ${e.deviceId}`},e.deviceId)))}),Object(d.jsx)("div",{className:"scanner-container",style:{width:"100%",maxWidth:"600px",margin:"0 auto"},children:te&&Object(d.jsx)(r.a,{onResult:oe,constraints:{deviceId:X||void 0,facingMode:"environment"},videoStyle:{width:"100%",height:"auto",maxHeight:"80vh"},containerStyle:{width:"100%",height:"auto"},videoContainerStyle:{width:"100%",height:"auto",paddingTop:"75%",position:"relative"}},X)}),Object(d.jsxs)("div",{className:"scanner-controls",children:[Object(d.jsx)("button",{onClick:async()=>{try{(await navigator.mediaDevices.getUserMedia({video:!0})).getTracks().forEach((e=>e.stop())),ae(!0),p(null)}catch(m){console.error("Error authorizing camera:",m),p("\u7121\u6cd5\u7372\u53d6\u651d\u50cf\u982d\u6b0a\u9650\u3002\u8acb\u78ba\u4fdd\u60a8\u5df2\u6388\u4e88\u651d\u50cf\u982d\u8a2a\u554f\u6b0a\u9650\u3002"),ae(!1)}},className:"authorize-camera-button",children:"\u6388\u6b0a\u651d\u50cf\u982d"}),Object(d.jsx)("button",{onClick:()=>{Y?(R(!1),ce(!1)):(R(!0),ce(!0))},className:Y?"stop-scan-button":"scan-button",disabled:!se,children:Y?"\u505c\u6b62\u6383\u63cf":"\u958b\u59cb\u6383\u63cf"}),Object(d.jsx)("button",{onClick:()=>{Z(!W),W||(R(!0),ce(!0))},className:"auto-scan-button "+(W?"active":""),disabled:!se,children:W?"\u95dc\u9589\u81ea\u52d5\u6383\u63cf":"\u958b\u555f\u81ea\u52d5\u6383\u63cf"})]})]}),Object(d.jsxs)("p",{className:"check-in-count",children:["\u4eca\u65e5\u7e3d\u7c3d\u5230\u6b21\u6578\uff1a",P]}),Object(d.jsxs)("p",{className:"total-people",children:["\u7e3d\u4eba\u6578\uff1a",U]}),n&&Object(d.jsx)("p",{className:"loading-message",children:"\u8f09\u5165\u4e2d..."})]}),c&&Object(d.jsxs)("section",{className:"participant-info",children:[Object(d.jsx)("h2",{children:"\u53c3\u8207\u8005\u8cc7\u8a0a"}),Object(d.jsx)("table",{className:"info-table",children:Object(d.jsxs)("tbody",{children:[Object(d.jsxs)("tr",{children:[Object(d.jsx)("td",{children:Object(d.jsx)("strong",{children:"ID"})}),Object(d.jsx)("td",{children:c.id}),Object(d.jsx)("td",{children:Object(d.jsx)("strong",{children:"\u72c0\u614b"})}),Object(d.jsx)("td",{children:c.isValid?"\u6709\u6548":"\u7121\u6548"})]}),Object(d.jsxs)("tr",{children:[Object(d.jsx)("td",{children:Object(d.jsx)("strong",{children:"\u4e2d\u6587\u59d3\u540d"})}),Object(d.jsx)("td",{children:c.name}),Object(d.jsx)("td",{children:Object(d.jsx)("strong",{children:"\u82f1\u6587\u59d3\u540d"})}),Object(d.jsx)("td",{children:c.ename})]}),Object(d.jsxs)("tr",{children:[Object(d.jsx)("td",{children:Object(d.jsx)("strong",{children:"\u8072\u90e8"})}),Object(d.jsx)("td",{children:c.voice}),Object(d.jsx)("td",{children:Object(d.jsx)("strong",{children:"\u4eca\u65e5\u5df2\u7c3d\u5230"})}),Object(d.jsx)("td",{children:c.signedToday?"\u662f":"\u5426"})]})]})}),c.checkIns&&c.checkIns.length>0&&Object(d.jsxs)("div",{className:"check-ins",children:[Object(d.jsx)("h3",{children:"\u7c3d\u5230\u8a18\u9304"}),Object(d.jsxs)("table",{className:"check-in-history-table",children:[Object(d.jsx)("thead",{children:Object(d.jsxs)("tr",{children:[Object(d.jsx)("th",{children:"\u5e8f\u865f"}),Object(d.jsx)("th",{children:"\u7c3d\u5230\u6642\u9593"})]})}),Object(d.jsx)("tbody",{children:c.checkIns.map(((e,t)=>Object(d.jsxs)("tr",{children:[Object(d.jsx)("td",{children:t+1}),Object(d.jsx)("td",{children:j(new Date(e))})]},t)))})]})]})]})]}),Object(d.jsx)("section",{className:"auth-section",children:Object(d.jsxs)("div",{className:"login-container",children:[Object(d.jsx)("h2",{children:"\u7ba1\u7406\u54e1\u767b\u5165"}),x?Object(d.jsxs)("div",{className:"admin-section",children:[Object(d.jsxs)("div",{className:"section-header",children:[Object(d.jsx)("h3",{children:"\u7ba1\u7406\u54e1\u529f\u80fd"}),Object(d.jsx)("button",{onClick:()=>{g(!1),y(""),K({})},className:"lock-button",children:"\u9396\u5b9a"})]}),Object(d.jsxs)("div",{className:"admin-controls",children:[Object(d.jsx)("input",{type:"text",value:T,onChange:e=>{A(e.target.value)},placeholder:"\u8f38\u5165\u7cfb\u7d71\u540d\u7a31",className:"input-field"}),Object(d.jsx)("input",{type:"text",value:_,onChange:e=>{F(e.target.value)},placeholder:"\u8f38\u5165\u7576\u524d\u6d3b\u52d5\u540d\u7a31",className:"input-field"}),Object(d.jsx)("input",{type:"file",onChange:e=>{e.target.files&&b(e.target.files[0])},accept:".xlsx,.xls",className:"file-input"}),Object(d.jsx)("button",{onClick:()=>w(!0),className:"upload-button",children:"\u4e0a\u50b3 Excel \u6a94\u6848"}),Object(d.jsx)("button",{onClick:()=>N(!0),className:"clear-button",children:"\u6e05\u9664\u6240\u6709\u8cc7\u6599"}),Object(d.jsx)("button",{onClick:async()=>{try{const e=await l.a.get(`${V}/api/export-checkins`,{responseType:"blob"}),t=new Blob([e.data],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),c=new Date,s=c.toISOString().split("T")[0],a=c.toTimeString().split(" ")[0].replace(/:/g,"-"),n=`${M||"Unnamed_Activity"}_${T}_${s}_${a}.xlsx`;Object(o.saveAs)(t,n),p(null)}catch(e){p("\u532f\u51fa\u7c3d\u5230\u8a18\u9304\u6642\u767c\u751f\u932f\u8aa4"),console.error("Error exporting check-ins:",e)}},className:"export-button",children:"\u532f\u51fa\u7c3d\u5230\u8a18\u9304"}),Object(d.jsx)("button",{onClick:async()=>{try{(await l.a.post(`${V}/api/reset-daily-check-in-count`)).data.success?(H(0),L("\u4eca\u65e5\u7e3d\u7c3d\u5230\u6b21\u6578\u5df2\u91cd\u7f6e")):p("\u91cd\u7f6e\u4eca\u65e5\u7e3d\u7c3d\u5230\u6b21\u6578\u5931\u6557")}catch(e){p("\u91cd\u7f6e\u4eca\u65e5\u7e3d\u7c3d\u5230\u6b21\u6578\u6642\u767c\u751f\u932f\u8aa4"),console.error("Error resetting daily check-in count:",e)}},className:"reset-button",children:"\u91cd\u7f6e\u4eca\u65e5\u7e3d\u7c3d\u5230\u6b21\u6578"})]}),Object(d.jsx)("p",{className:"upload-status",children:u}),f&&Object(d.jsx)("div",{className:"modal update-confirmation",children:Object(d.jsxs)("div",{className:"modal-content",children:[Object(d.jsx)("h3",{children:"\u78ba\u8a8d\u66f4\u65b0"}),Object(d.jsx)("p",{children:"\u60a8\u78ba\u5b9a\u8981\u4e0a\u50b3\u65b0\u7684\u53c3\u8207\u8005\u8cc7\u6599\u55ce\uff1f\u9019\u5c07\u6703\u8986\u84cb\u73fe\u6709\u7684\u8cc7\u6599\u3002"}),Object(d.jsxs)("div",{className:"button-group",children:[Object(d.jsx)("button",{onClick:async()=>{if(!h)return void O("\u672a\u9078\u64c7\u6a94\u6848");const e=new FormData;e.append("file",h),e.append("activityName",_);try{const t=await l.a.post(`${V}/api/upload-participants`,e,{headers:{"Content-Type":"multipart/form-data"}});O("\u53c3\u8207\u8005\u8cc7\u6599\u66f4\u65b0\u6210\u529f"),await ie(),z(t.data.totalPeople),q(_),p(null),w(!1)}catch(t){console.error("File upload error:",t),O("\u4e0a\u50b3\u6a94\u6848\u6642\u767c\u751f\u932f\u8aa4"),l.a.isAxiosError(t)&&t.response?p(`\u932f\u8aa4\uff1a${t.response.status} - ${JSON.stringify(t.response.data)}`):p("\u6a94\u6848\u4e0a\u50b3\u6642\u767c\u751f\u672a\u77e5\u932f\u8aa4")}},className:"confirm-update-button",children:"\u78ba\u8a8d"}),Object(d.jsx)("button",{onClick:()=>w(!1),className:"cancel-update-button",children:"\u53d6\u6d88"})]})]})}),k&&Object(d.jsx)("div",{className:"modal clear-confirmation",children:Object(d.jsxs)("div",{className:"modal-content",children:[Object(d.jsx)("h3",{children:"\u78ba\u8a8d\u6e05\u9664"}),Object(d.jsx)("p",{children:"\u60a8\u78ba\u5b9a\u8981\u6e05\u9664\u6240\u6709\u53c3\u8207\u8005\u8cc7\u6599\u55ce\uff1f\u6b64\u64cd\u4f5c\u7121\u6cd5\u64a4\u92b7\u3002"}),Object(d.jsxs)("div",{className:"button-group",children:[Object(d.jsx)("button",{onClick:async()=>{try{const e=await l.a.post(`${V}/api/clear-participants`);O("\u6240\u6709\u53c3\u8207\u8005\u8cc7\u6599\u5df2\u6210\u529f\u6e05\u9664"),a(null),p(null),N(!1),K({}),z(e.data.totalPeople)}catch(e){O("\u6e05\u9664\u53c3\u8207\u8005\u8cc7\u6599\u6642\u767c\u751f\u932f\u8aa4"),l.a.isAxiosError(e)&&e.response?p(`\u932f\u8aa4\uff1a${e.response.status} - ${e.response.data}`):p("\u6e05\u9664\u8cc7\u6599\u6642\u767c\u751f\u672a\u77e5\u932f\u8aa4")}},className:"confirm-clear-button",children:"\u78ba\u8a8d"}),Object(d.jsx)("button",{onClick:()=>N(!1),className:"cancel-clear-button",children:"\u53d6\u6d88"})]})]})})]}):Object(d.jsxs)("form",{onSubmit:async e=>{e.preventDefault(),"hkacmadmin"===v?(g(!0),await(async()=>{try{const e=await l.a.get(`${V}/api/participants`),t={};e.data.forEach((e=>{t[e.id]=e}));const c=Object.values(t).sort(((e,t)=>{const c=e.checkIns&&e.checkIns.length>0?new Date(e.checkIns[0]).getTime():0;return(t.checkIns&&t.checkIns.length>0?new Date(t.checkIns[0]).getTime():0)-c})),s={};c.forEach((e=>{s[e.id]=e})),K(s),z(Object.keys(s).length),p(null)}catch(e){p("\u7121\u6cd5\u7372\u53d6\u53c3\u8207\u8005\u8cc7\u6599\u3002\u8acb\u7a0d\u5f8c\u518d\u8a66\u3002"),console.error("Error fetching participants:",e)}})(),await le()):p("\u5bc6\u78bc\u932f\u8aa4")},className:"login-form",children:[Object(d.jsx)("input",{type:"password",value:v,onChange:e=>{y(e.target.value)},placeholder:"\u8f38\u5165\u7ba1\u7406\u54e1\u5bc6\u78bc",className:"input-field"}),Object(d.jsx)("button",{type:"submit",className:"submit-button",children:"\u767b\u5165"})]})]})}),x&&Object(d.jsxs)("section",{className:"participant-table",children:[Object(d.jsx)("h2",{children:"\u53c3\u8207\u8005\u5217\u8868"}),Object(d.jsx)("div",{className:"table-container",children:Object(d.jsxs)("table",{children:[Object(d.jsx)("thead",{children:Object(d.jsxs)("tr",{children:[Object(d.jsx)("th",{children:"\u5e8f\u865f"}),Object(d.jsx)("th",{children:"ID"}),Object(d.jsx)("th",{children:"\u4e2d\u6587\u59d3\u540d"}),Object(d.jsx)("th",{children:"\u82f1\u6587\u59d3\u540d"}),Object(d.jsx)("th",{children:"\u8072\u90e8"}),Object(d.jsx)("th",{children:"\u72c0\u614b"}),Object(d.jsx)("th",{children:"\u4eca\u65e5\u5df2\u7c3d\u5230"}),Object(d.jsx)("th",{children:"\u7c3d\u5230\u8a18\u9304"})]})}),Object(d.jsx)("tbody",{children:Object.values(B).map(((e,t)=>{const c=new Date,s=new Date(c.getFullYear(),c.getMonth(),c.getDate()),a=e.checkIns.some((e=>new Date(e)>=s));return Object(d.jsxs)("tr",{children:[Object(d.jsx)("td",{children:t+1}),Object(d.jsx)("td",{children:e.id}),Object(d.jsx)("td",{children:e.name}),Object(d.jsx)("td",{children:e.ename}),Object(d.jsx)("td",{children:e.voice}),Object(d.jsx)("td",{children:e.isValid?"\u6709\u6548":"\u7121\u6548"}),Object(d.jsx)("td",{children:a?"\u662f":"\u5426"}),Object(d.jsx)("td",{children:e.checkIns&&e.checkIns.length>0?Object(d.jsx)("ul",{className:"check-in-list",children:e.checkIns.map(((e,t)=>Object(d.jsx)("li",{children:j(new Date(e))},t)))}):"\u672a\u7c3d\u5230"})]},e.id)}))})]})})]})]})};i.a.render(Object(d.jsx)(a.a.StrictMode,{children:Object(d.jsx)(h,{})}),document.getElementById("root"))}},[[24,1,2]]]);
//# sourceMappingURL=main.f4f60aa6.chunk.js.map